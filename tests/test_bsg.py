from BokehStructureGraph.BokehStructureGraph import BokehStructureGraph as BSG
from bokeh.plotting import figure
import networkx as nx
import json


Kref = """
{"directed": true, "multigraph": false, "graph": {"graph": {"rankdir": "LR"}}, "nodes": [{"model": "Line", "id": "1035"}, {"model": "PanTool", "id": "1020"}, {"model": "GlyphRenderer", "id": "1036"}, {"model": "HelpTool", "id": "1025"}, {"model": "Toolbar", "id": "1026"}, {"model": "Title", "id": "1038"}, {"model": "DataRange1d", "id": "1004"}, {"model": "CDSView", "id": "1037"}, {"model": "WheelZoomTool", "id": "1021"}, {"model": "DataRange1d", "id": "1002"}, {"model": "BasicTicker", "id": "1016"}, {"model": "UnionRenderers", "id": "1044"}, {"model": "LinearScale", "id": "1006"}, {"model": "Selection", "id": "1045"}, {"model": "Grid", "id": "1014"}, {"model": "BasicTicker", "id": "1011"}, {"model": "BasicTickFormatter", "id": "1043"}, {"model": "ColumnDataSource", "id": "1033"}, {"model": "BoxAnnotation", "id": "1046"}, {"model": "LinearAxis", "id": "1010"}, {"model": "Grid", "id": "1019"}, {"model": "BasicTickFormatter", "id": "1041"}, {"model": "Figure", "id": "1001"}, {"model": "LinearAxis", "id": "1015"}, {"model": "Line", "id": "1034"}, {"model": "LinearScale", "id": "1008"}, {"model": "BoxZoomTool", "id": "1022"}, {"model": "SaveTool", "id": "1023"}, {"model": "ResetTool", "id": "1024"}], "links": [{"source": "1036", "target": "1035"}, {"source": "1036", "target": "1037"}, {"source": "1036", "target": "1033"}, {"source": "1036", "target": "1034"}, {"source": "1026", "target": "1020"}, {"source": "1026", "target": "1025"}, {"source": "1026", "target": "1021"}, {"source": "1026", "target": "1022"}, {"source": "1026", "target": "1023"}, {"source": "1026", "target": "1024"}, {"source": "1037", "target": "1033"}, {"source": "1014", "target": "1011"}, {"source": "1033", "target": "1044"}, {"source": "1033", "target": "1045"}, {"source": "1010", "target": "1011"}, {"source": "1010", "target": "1043"}, {"source": "1019", "target": "1016"}, {"source": "1001", "target": "1036"}, {"source": "1001", "target": "1026"}, {"source": "1001", "target": "1038"}, {"source": "1001", "target": "1004"}, {"source": "1001", "target": "1002"}, {"source": "1001", "target": "1006"}, {"source": "1001", "target": "1014"}, {"source": "1001", "target": "1010"}, {"source": "1001", "target": "1019"}, {"source": "1001", "target": "1015"}, {"source": "1001", "target": "1008"}, {"source": "1015", "target": "1016"}, {"source": "1015", "target": "1041"}, {"source": "1022", "target": "1046"}]}
"""

KKref = """
{"directed": true, "multigraph": false, "graph": {"graph": {"rankdir": "LR"}}, "nodes": [{"model": "GroupFilter", "id": "2384"}, {"model": "DataTable", "id": "2386"}, {"model": "Selection", "id": "2402"}, {"model": "Plot", "id": "2359"}, {"model": "LabelSet", "id": "2374"}, {"model": "StringFormatter", "id": "2399"}, {"model": "Toolbar", "id": "2377"}, {"model": "HoverTool", "id": "2372"}, {"model": "Label", "id": "2376"}, {"model": "CustomJS", "id": "2388"}, {"model": "ColumnDataSource", "id": "2383"}, {"model": "Selection", "id": "2389"}, {"model": "ColumnDataSource", "id": "2357"}, {"model": "MultiLine", "id": "2369"}, {"model": "Circle", "id": "2366"}, {"model": "StringEditor", "id": "2400"}, {"model": "TableColumn", "id": "2382"}, {"model": "TableColumn", "id": "2381"}, {"model": "LinearScale", "id": "2391"}, {"model": "CDSView", "id": "2371"}, {"model": "UnionRenderers", "id": "2401"}, {"model": "StringEditor", "id": "2398"}, {"model": "Selection", "id": "2396"}, {"model": "ColumnDataSource", "id": "2358"}, {"model": "Range1d", "id": "2362"}, {"model": "GlyphRenderer", "id": "2367"}, {"model": "Title", "id": "2387"}, {"model": "UnionRenderers", "id": "2403"}, {"model": "PanTool", "id": "2380"}, {"model": "LinearScale", "id": "2394"}, {"model": "GlyphRenderer", "id": "2370"}, {"model": "ResetTool", "id": "2379"}, {"model": "Circle", "id": "2364"}, {"model": "StringFormatter", "id": "2397"}, {"model": "Range1d", "id": "2360"}, {"model": "BoxAnnotation", "id": "2405"}, {"model": "TapTool", "id": "2373"}, {"model": "BoxZoomTool", "id": "2378"}, {"model": "UnionRenderers", "id": "2395"}, {"model": "CDSView", "id": "2385"}, {"model": "Circle", "id": "2365"}, {"model": "CDSView", "id": "2368"}, {"model": "Column", "id": "2390"}], "links": [{"source": "2386", "target": "2383"}, {"source": "2386", "target": "2382"}, {"source": "2386", "target": "2381"}, {"source": "2386", "target": "2385"}, {"source": "2359", "target": "2374"}, {"source": "2359", "target": "2377"}, {"source": "2359", "target": "2376"}, {"source": "2359", "target": "2391"}, {"source": "2359", "target": "2362"}, {"source": "2359", "target": "2367"}, {"source": "2359", "target": "2387"}, {"source": "2359", "target": "2394"}, {"source": "2359", "target": "2370"}, {"source": "2359", "target": "2360"}, {"source": "2374", "target": "2357"}, {"source": "2377", "target": "2372"}, {"source": "2377", "target": "2380"}, {"source": "2377", "target": "2379"}, {"source": "2377", "target": "2373"}, {"source": "2377", "target": "2378"}, {"source": "2372", "target": "2367"}, {"source": "2388", "target": "2384"}, {"source": "2388", "target": "2386"}, {"source": "2388", "target": "2383"}, {"source": "2388", "target": "2357"}, {"source": "2383", "target": "2396"}, {"source": "2383", "target": "2395"}, {"source": "2357", "target": "2389"}, {"source": "2357", "target": "2403"}, {"source": "2382", "target": "2399"}, {"source": "2382", "target": "2400"}, {"source": "2381", "target": "2398"}, {"source": "2381", "target": "2397"}, {"source": "2371", "target": "2358"}, {"source": "2358", "target": "2402"}, {"source": "2358", "target": "2401"}, {"source": "2367", "target": "2357"}, {"source": "2367", "target": "2366"}, {"source": "2367", "target": "2364"}, {"source": "2367", "target": "2365"}, {"source": "2367", "target": "2368"}, {"source": "2370", "target": "2369"}, {"source": "2370", "target": "2371"}, {"source": "2370", "target": "2358"}, {"source": "2373", "target": "2367"}, {"source": "2378", "target": "2405"}, {"source": "2385", "target": "2384"}, {"source": "2385", "target": "2383"}, {"source": "2368", "target": "2357"}, {"source": "2390", "target": "2386"}, {"source": "2390", "target": "2359"}]}
"""


def test_bsg_stage_one():
    f = figure()
    f.line(x=[1, 2, 3], y=[1, 2, 3])
    Kref_graph = nx.node_link_graph(json.loads(Kref))
    K = BSG(f)
    assert nx.is_isomorphic(K.graph, Kref_graph)

def test_bsg_stage_two():
    f = figure()
    f.line(x=[1, 2, 3], y=[1, 2, 3])
    KKref_graph = nx.node_link_graph(json.loads(KKref))
    K = BSG(f)
    KK = BSG(K.model)
    assert nx.is_isomorphic(KK.graph, KKref_graph)
